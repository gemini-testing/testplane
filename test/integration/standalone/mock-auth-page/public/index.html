<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Authentication Test</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                max-width: 600px;
                margin: 50px auto;
                padding: 20px;
                background-color: #f5f5f5;
            }
            .container {
                background: white;
                padding: 30px;
                border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            }
            .form-group {
                margin-bottom: 15px;
            }
            label {
                display: block;
                margin-bottom: 5px;
                font-weight: bold;
            }
            input[type="text"],
            input[type="password"] {
                width: 100%;
                padding: 8px;
                border: 1px solid #ddd;
                border-radius: 4px;
                box-sizing: border-box;
            }
            button {
                background-color: #007bff;
                color: white;
                padding: 10px 20px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                margin-right: 10px;
            }
            button:hover {
                background-color: #0056b3;
            }
            .message {
                padding: 10px;
                margin: 10px 0;
                border-radius: 4px;
            }
            .success {
                background-color: #d4edda;
                color: #155724;
                border: 1px solid #c3e6cb;
            }
            .error {
                background-color: #f8d7da;
                color: #721c24;
                border: 1px solid #f5c6cb;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>Authentication Test Page</h1>

            <div id="authStatus"></div>

            <div id="loginForm" style="display: none">
                <h2>Login</h2>
                <form id="loginFormElement">
                    <div class="form-group">
                        <label for="login">Login:</label>
                        <input type="text" id="login" name="login" required />
                    </div>
                    <div class="form-group">
                        <label for="password">Password:</label>
                        <input type="password" id="password" name="password" required />
                    </div>
                    <button type="submit">Login</button>
                </form>
            </div>

            <div id="userInfo" style="display: none">
                <h2>Welcome, <span id="userName"></span>!</h2>
                <button onclick="logout()">Logout</button>
            </div>
        </div>

        <script>
            class AuthClient {
                constructor() {
                    this.init();
                }

                async init() {
                    await this.checkAuthStatus();
                }

                async checkAuthStatus() {
                    try {
                        const response = await fetch("/api/check-auth", {
                            credentials: "include",
                        });
                        const data = await response.json();

                        if (data.authenticated) {
                            this.showAuthenticated(data.login);
                        } else {
                            this.showLoginForm();
                        }
                    } catch (error) {
                        console.error("Error checking auth status:", error);
                        this.showLoginForm();
                    }
                }

                async login(login, password) {
                    try {
                        const response = await fetch("/api/login", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            credentials: "include",
                            body: JSON.stringify({ login, password }),
                        });

                        const data = await response.json();

                        if (data.success) {
                            localStorage.setItem("currentSession", data.login);
                            sessionStorage.setItem("currentSession", data.login);

                            this.showAuthenticated(data.login);
                        }
                    } catch (error) {
                        console.error("Login error:", error);
                    }
                }

                async logout() {
                    try {
                        await fetch("/api/logout", {
                            method: "POST",
                            credentials: "include",
                        });

                        localStorage.clear();
                        sessionStorage.clear();

                        this.showLoginForm();
                    } catch (error) {
                        console.error("Logout error:", error);
                    }
                }

                showAuthenticated(login) {
                    document.getElementById("authStatus").innerHTML =
                        '<div id="status" class="message success">You are logged in</div>';
                    document.getElementById("userName").textContent = login;
                    document.getElementById("loginForm").style.display = "none";
                    document.getElementById("userInfo").style.display = "block";
                }

                showLoginForm() {
                    document.getElementById("authStatus").innerHTML =
                        '<div id="status" class="message error">You are not logged in</div>';
                    document.getElementById("loginForm").style.display = "block";
                    document.getElementById("userInfo").style.display = "none";
                }
            }

            const authClient = new AuthClient();

            document.getElementById("loginFormElement").addEventListener("submit", function (e) {
                e.preventDefault();

                const login = document.getElementById("login").value;
                const password = document.getElementById("password").value;

                authClient.login(login, password);
            });

            function logout() {
                authClient.logout();
            }
        </script>
    </body>
</html>
